name: Build & Release HACS Package

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # --- Clone repo ---
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') && 'develop' || 'main' }}  # â† Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ğ²ĞµÑ‚ĞºĞ¸

      # --- Extract version from tag ---
      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¸Ğ· ĞºĞ°ĞºĞ¾Ğ¹ Ğ²ĞµÑ‚ĞºĞ¸ ÑĞ¾Ğ±Ğ¸Ñ€Ğ°Ñ‚ÑŒ
          if [[ "$VERSION" == *"-rc"* ]] || [[ "$VERSION" == *"-beta"* ]] || [[ "$VERSION" == *"-alpha"* ]]; then
            echo "branch=develop" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      # --- Re-checkout from correct branch ---
      - name: Checkout correct branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.version.outputs.branch }}

      # --- Show build info ---
      - name: Build information
        run: |
          echo "Building version: ${{ steps.version.outputs.version }}"
          echo "From branch: ${{ steps.version.outputs.branch }}"
          echo "Pre-release: ${{ steps.version.outputs.is_prerelease }}"
          echo "Current commit: $(git rev-parse HEAD)"

      # --- Automatic changelog ---
      - name: Generate changelog
        id: changelog
        uses: metcalfc/changelog-generator@v4
        with:
          myToken: ${{ secrets.GITHUB_TOKEN }}

      # --- Update manifest.json ---
      - name: Update manifest.json
        run: |
          jq '.version = "${{ steps.version.outputs.version }}"' \
            custom_components/terneo_bx/manifest.json > tmp.json
          mv tmp.json custom_components/terneo_bx/manifest.json

      # --- Commit updated manifest.json (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ… Ñ€ĞµĞ»Ğ¸Ğ·Ğ¾Ğ²) ---
      - name: Commit version bump
        if: steps.version.outputs.is_prerelease == 'false'  # â† ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¸Ğ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ…
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add custom_components/terneo_bx/manifest.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ”– Bump version to v${{ steps.version.outputs.version }}"
            git push origin ${{ steps.version.outputs.branch }}
          fi
 
      # --- Create ZIP archive ---
      - name: Create ZIP archive
        run: |
          zip -r terneo_bx.zip custom_components/
          sha256sum terneo_bx.zip > terneo_bx.zip.sha256
 
      # --- Publish Release ---
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref }}
          name: "${{ steps.version.outputs.is_prerelease == 'true' && 'ğŸ§ª' || 'ğŸš€' }} Terneo BX v${{ steps.version.outputs.version }}"
          body: |
            # Terneo BX v${{ steps.version.outputs.version }}
            
            **Branch:** `${{ steps.version.outputs.branch }}`
            **Commit:** `${{ github.sha }}`
            
            ${{ steps.changelog.outputs.changelog }}
            
            ## ğŸ“¦ Installation
            
            ### Via HACS
            1. HACS â†’ Integrations â†’ â‹® â†’ Custom repositories
            2. Add: `https://github.com/kilkams/terneo_plus`
            3. Search "Terneo BX" â†’ Install
            
            ### Manual
            1. Download `terneo_bx.zip`
            2. Extract to `config/custom_components/`
            3. Restart Home Assistant
            
            ${{ steps.version.outputs.is_prerelease == 'true' && 'âš ï¸ **This is a pre-release version for testing purposes.**' || '' }}
          prerelease: ${{ steps.version.outputs.is_prerelease == 'true' }}
          files: |
            terneo_bx.zip
            terneo_bx.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- Notify on success ---
      - name: Build summary
        if: success()
        run: |
          echo "âœ… Release v${{ steps.version.outputs.version }} created successfully!"
          echo "ğŸ“¦ Branch: ${{ steps.version.outputs.branch }}"
          echo "${{ steps.version.outputs.is_prerelease == 'true' && 'ğŸ§ª Pre-release' || 'ğŸš€ Stable release' }}"
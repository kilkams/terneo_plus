name: Build & Release HACS Package

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # --- Determine branch from tag ---
      - name: Determine branch
        id: branch
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ²ĞµÑ‚ĞºÑƒ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ²ĞµÑ€ÑĞ¸Ğ¸
          if [[ "$VERSION" == *"-rc"* ]] || [[ "$VERSION" == *"-beta"* ]] || [[ "$VERSION" == *"-alpha"* ]]; then
            echo "branch=develop" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "Building pre-release from develop"
          else
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "Building stable release from main"
          fi

      # --- Clone repo from correct branch ---
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.branch.outputs.branch }}

      # --- Show build info ---
      - name: Build information
        run: |
          echo "ğŸ“¦ Building version: ${{ steps.branch.outputs.version }}"
          echo "ğŸŒ¿ From branch: ${{ steps.branch.outputs.branch }}"
          echo "ğŸ·ï¸  Tag: ${{ steps.branch.outputs.tag_name }}"
          echo "ğŸ§ª Pre-release: ${{ steps.branch.outputs.is_prerelease }}"
          echo "ğŸ“ Current commit: $(git rev-parse HEAD)"
          echo "ğŸ“ Current branch: $(git branch --show-current || echo 'detached HEAD')"

      # --- Automatic changelog ---
      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG="## ğŸ‰ Initial Release"
          else
            echo "Generating changelog from $PREVIOUS_TAG to ${{ steps.branch.outputs.tag_name }}"
            
            COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s (%h)" --no-merges)
            
            FEATURES=$(echo "$COMMITS" | grep -E "^feat[:(]" | sed 's/^feat[:(] */- /' || echo "")
            FIXES=$(echo "$COMMITS" | grep -E "^fix[:(]" | sed 's/^fix[:(] */- /' || echo "")
            DOCS=$(echo "$COMMITS" | grep -E "^docs[:(]" | sed 's/^docs[:(] */- /' || echo "")
            CHORE=$(echo "$COMMITS" | grep -E "^chore[:(]" | sed 's/^chore[:(] */- /' || echo "")
            OTHERS=$(echo "$COMMITS" | grep -vE "^(feat|fix|docs|chore)[:(]" | sed 's/^/- /' || echo "")
            
            CHANGELOG="## ğŸ“‹ Changes\n\n"
            
            [ -n "$FEATURES" ] && CHANGELOG="${CHANGELOG}### âœ¨ New Features\n${FEATURES}\n\n"
            [ -n "$FIXES" ] && CHANGELOG="${CHANGELOG}### ğŸ› Bug Fixes\n${FIXES}\n\n"
            [ -n "$DOCS" ] && CHANGELOG="${CHANGELOG}### ğŸ“š Documentation\n${DOCS}\n\n"
            [ -n "$CHORE" ] && CHANGELOG="${CHANGELOG}### ğŸ”§ Maintenance\n${CHORE}\n\n"
            [ -n "$OTHERS" ] && CHANGELOG="${CHANGELOG}### ğŸ“ Other Changes\n${OTHERS}\n\n"
          fi
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # --- Update manifest.json ---
      - name: Update manifest.json
        run: |
          jq '.version = "${{ steps.branch.outputs.version }}"' \
            custom_components/terneo_bx/manifest.json > tmp.json
          mv tmp.json custom_components/terneo_bx/manifest.json
          
          echo "Updated manifest.json to version ${{ steps.branch.outputs.version }}"

      # --- Commit updated manifest.json (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ… Ñ€ĞµĞ»Ğ¸Ğ·Ğ¾Ğ²) ---
      - name: Commit version bump
        if: steps.branch.outputs.is_prerelease == 'false'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add custom_components/terneo_bx/manifest.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ”– Bump version to v${{ steps.branch.outputs.version }}"
            git push origin ${{ steps.branch.outputs.branch }}
            echo "âœ… Version bumped and pushed to ${{ steps.branch.outputs.branch }}"
          fi
 
      # --- Create ZIP archive ---
      - name: Create ZIP archive
        run: |
          zip -r terneo_bx.zip custom_components/
          sha256sum terneo_bx.zip > terneo_bx.zip.sha256
          
          echo "ğŸ“¦ Archive created:"
          ls -lh terneo_bx.zip
          echo "ğŸ” Checksum:"
          cat terneo_bx.zip.sha256
 
      # --- Publish Release ---
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.branch.outputs.tag_name }}
          name: "${{ steps.branch.outputs.is_prerelease == 'true' && 'ğŸ§ª' || 'ğŸš€' }} Terneo BX v${{ steps.branch.outputs.version }}"
          body: |
            # Terneo BX v${{ steps.branch.outputs.version }}
            
            **Branch:** `${{ steps.branch.outputs.branch }}`
            **Commit:** `${{ github.sha }}`
            
            ${{ steps.changelog.outputs.changelog }}
            
            ## ğŸ“¦ Installation
            
            ### Via HACS
            1. HACS â†’ Integrations â†’ â‹® â†’ Custom repositories
            2. Add: `https://github.com/kilkams/terneo_plus`
            3. Search "Terneo Plus" â†’ Install
            
            ### Manual
            1. Download `terneo_bx.zip`
            2. Extract to `config/custom_components/`
            3. Restart Home Assistant
            
            ${{ steps.branch.outputs.is_prerelease == 'true' && 'âš ï¸ **This is a pre-release version for testing purposes.**' || '' }}
          prerelease: ${{ steps.branch.outputs.is_prerelease == 'true' }}
          files: |
            terneo_bx.zip
            terneo_bx.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- Success notification ---
      - name: Build summary
        if: success()
        run: |
          echo "âœ… Release v${{ steps.branch.outputs.version }} created successfully!"
          echo "ğŸ“¦ Branch: ${{ steps.branch.outputs.branch }}"
          echo "${{ steps.branch.outputs.is_prerelease == 'true' && 'ğŸ§ª Pre-release' || 'ğŸš€ Stable release' }}"